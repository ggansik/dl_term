#Total model - Tacotron whole model
import torch
import torch.nn as nn
import torch.optim as optim
from torch.autograd import Variable
from torch.utils.data import DataLoader
from torch.utils.data import sampler
import torch.nn.functional as F

import torchvision.datasets as dset
import torchvision.transforms as T

import numpy as np

from .encoder import HighwayNet, EncoderCBHG, Prenet, Encoder
from .decoder import HighwayNet, DecoderCBHG, AttentionWrapper, BahnadauAttention, Decoder


class PostProcessing(nn.Module):
    """
    make post processing data
    input : (B, decoder.T, spect_dim)
    """
    def __init__(self, spect_dim):
        super(PostProcessing, self).__init__()
        self.postcbhg = DecoderCBHG(K=8)
        self.linear = nn.Linear(spect_dim * 2, 1025)
    def forward(self, batch_size, data):
        """
            make data shape (B, -1, 80)
        """
        data = data.view(batch_size, -1, 80)
        output = self.postcbhg(data)
        output = self.linear(output)
        
        return output


class Tacotron(nn.Modules):
    def __init__(self, vocab_num, input_dim=256, spect_dim=80):
        super(Tacotron, self).__init__()
        self.input_dim = input_dim
        self.spect_dim = spect_dim
        self.embedding = nn.Embedding(vocab_num, input_dim) #embedding dimension
        self.embedding.weight.data.normal_(0,0.3)
        self.Encoder = Encoder(x)
        self.Decoder = Decoder(in_dim, r=2) #write input_dimension
        self.Postprocessing = PostProcessing(spect_dim)
    def forward(self, inputs, spect_targets=None, r= 2):
        """
        make total model!
        input : (B, encoder.T, in_dim)
        
        """
        batch_size = inputs.size(0)
        memory = self.embedding(inputs)
        
        #encoding
        #(B, encoder.T, input_dim)
        memory = self.Encoder(memory)
        
        #decoding
        #(B, encoder.T, mel_dim * r)
        decoder_output = self.decoder(memory, spect_targets)
        
        #postprocessing
        #(B, decoder.T, 1025)
        decoder_output = decoder_output.view(B, -1, self.spect_dim)
        wav_output = self.PostProcessing(batch_size, decoder_output)
        
        return decoder_output, wav_output